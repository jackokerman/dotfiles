#!/bin/bash
# Prevent content from overlay repos from leaking into personal dotfiles
#
# Blocked patterns are read from ~/.dotfiles-blocked-patterns (one per line)
# This file is typically created by a work dotfiles overlay during bootstrap.

set -e

PATTERNS_FILE="$HOME/.dotfiles-blocked-patterns"

# If no patterns file exists, nothing to block
if [ ! -f "$PATTERNS_FILE" ]; then
    exit 0
fi

# Read patterns into array (skip empty lines and comments)
patterns=()
while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    patterns+=("$line")
done < "$PATTERNS_FILE"

# If no patterns, nothing to block
if [ ${#patterns[@]} -eq 0 ]; then
    exit 0
fi

# Build combined regex pattern
combined_pattern=$(IFS="|"; echo "${patterns[*]}")

# Check staged files for blocked patterns
if git diff --cached --diff-filter=ACMR | grep -qiE "$combined_pattern"; then
    echo "ERROR: Staged changes contain blocked content."
    echo ""
    echo "This repo is for personal dotfiles only."
    echo "Check ~/.dotfiles-blocked-patterns for blocked patterns."
    echo ""
    echo "To see matches: git diff --cached | grep -iE '$combined_pattern'"
    echo ""
    exit 1
fi

exit 0
